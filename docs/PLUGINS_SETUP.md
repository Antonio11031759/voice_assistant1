# Настройка новых плагинов

## Обзор

В этом проекте добавлены три новых плагина:
1. **Тестовый плагин** - для изучения архитектуры
2. **Spotify интеграция** - для управления музыкой
3. **Home Assistant интеграция** - для управления умным домом

## Тестовый плагин

### Описание
Простой плагин для тестирования системы и изучения архитектуры.

### Команды
- `тест` - простая тестовая команда
- `как дела` - проверка состояния системы
- `время` - получение текущего времени

### Настройка
Файл: `options/test.json`
```json
{
    "is_active": true,
    "test_message": "Тестовый плагин работает отлично!"
}
```

## Spotify интеграция

### Описание
Плагин для управления музыкой через Spotify API.

### Команды
- `включи музыку` - включить/поставить на паузу
- `следующий трек` - следующий трек
- `предыдущий трек` - предыдущий трек
- `поставь трек [название]` - поиск и воспроизведение трека
- `статус музыки` - что сейчас играет

### Настройка

#### 1. Создание приложения в Spotify Developer
1. Перейдите на [Spotify Developer Dashboard](https://developer.spotify.com/dashboard)
2. Создайте новое приложение
3. Получите `Client ID` и `Client Secret`
4. Добавьте redirect URI: `http://localhost:5003/spotify_callback`

#### 2. Настройка конфигурации
Файл: `options/spotify.json`
```json
{
    "is_active": true,
    "client_id": "ваш_client_id",
    "client_secret": "ваш_client_secret",
    "redirect_uri": "http://localhost:5003/spotify_callback",
    "auth_code": ""
}
```

#### 3. Получение auth_code
1. Откройте в браузере URL авторизации:
   ```
   https://accounts.spotify.com/authorize?client_id=ВАШ_CLIENT_ID&response_type=code&redirect_uri=http://localhost:5003/spotify_callback&scope=user-read-playback-state,user-modify-playback-state,user-read-currently-playing,playlist-read-private,user-library-read
   ```
2. Авторизуйтесь в Spotify
3. Скопируйте код из redirect URI
4. Вставьте код в поле `auth_code` в конфигурации

## Home Assistant интеграция

### Описание
Плагин для управления умным домом через Home Assistant API.

### Команды
- `включи свет` - включить основное освещение
- `выключи свет` - выключить все источники света
- `включи свет в [комнате]` - включить свет в конкретной комнате
- `температура дома` - получить температуру в доме
- `влажность дома` - получить влажность в доме
- `статус устройств` - статус всех устройств
- `готовлюсь ко сну` - сценарий подготовки ко сну
- `ухожу из дома` - сценарий ухода из дома

### Настройка

#### 1. Создание Long-Lived Access Token
1. В Home Assistant перейдите в Profile → Long-Lived Access Tokens
2. Создайте новый токен
3. Скопируйте токен

#### 2. Настройка конфигурации
Файл: `options/homeassistant.json`
```json
{
    "is_active": true,
    "base_url": "http://localhost:8123",
    "access_token": "ваш_access_token",
    "default_room": "гостиная"
}
```

## Установка и запуск

### 1. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 2. Настройка плагинов
1. Скопируйте файлы конфигурации в папку `options/`
2. Настройте параметры для каждого плагина
3. Установите `is_active: true` для нужных плагинов

### 3. Запуск системы
```bash
python runva_webapi.py
```

### 4. Проверка работы
1. Откройте веб-интерфейс: `http://localhost:5003`
2. Протестируйте команды через веб-клиент
3. Проверьте логи на наличие ошибок

## Структура плагинов

### Основные компоненты
- `start(core)` - инициализация плагина
- `start_with_options(core, manifest)` - настройка с опциями
- `manifest` - описание плагина и команд

### Пример структуры
```python
def start(core: VACore):
    manifest = {
        'name': 'Название плагина',
        'version': '1.0',
        'require_online': True,
        'commands': {
            'команда|альтернативная команда': функция_обработчик,
        }
    }
    return manifest

def функция_обработчик(core: VACore, phrase: str):
    # Логика обработки команды
    core.play_voice_assistant_speech("Ответ пользователю")
```

## Устранение неполадок

### Spotify
- Проверьте правильность `client_id` и `client_secret`
- Убедитесь, что `redirect_uri` совпадает с настройками в Spotify
- Проверьте, что `auth_code` получен и вставлен

### Home Assistant
- Проверьте доступность Home Assistant по указанному URL
- Убедитесь в правильности `access_token`
- Проверьте права доступа токена

### Общие проблемы
- Проверьте логи системы на наличие ошибок
- Убедитесь, что все зависимости установлены
- Проверьте права доступа к файлам конфигурации

## Разработка новых плагинов

### Рекомендации
1. Изучите существующие плагины как примеры
2. Следуйте структуре `manifest`
3. Используйте `core.play_voice_assistant_speech()` для ответов
4. Обрабатывайте ошибки и edge cases
5. Добавляйте логирование для отладки

### Тестирование
1. Создайте простую версию плагина
2. Протестируйте базовую функциональность
3. Добавляйте сложные функции постепенно
4. Тестируйте в различных сценариях
